"use strict";!function(){!function(){var a;a=window.drahak=window.drahak||{},a.chat=angular.module("drahak.chat",[]),a.chat.constant("DEBUG",!1),a.chat.value("host",a.chat.host="ws://chat.itnetwork.cz"),a.chat.value("avatarExt","_thumb.png"),a.chat.value("states",["online","offline","busy","away"]),a.chat.value("writingStates",{idle:"state_idle",typing:"state_typing"}),a.chat.value("userStates",{states:{online:"online",busy:"busy",away:"away",offline:"offline",priority:{online:1,busy:2,away:3,offline:4}},isState:function(a){return!angular.isUndefined(this.states[a])},doNotDisturb:function(a){return a==this.states.busy||a==this.states.offline},sort:function(a,b){return this.states.priority[a]-this.states.priority[b]}}),a.chat.bootstrap=function(b,c){var d=null;angular.module("drahak.chat").config(["$provide",function(a){a.value("port",c.port),a.value("avatarDefault",c.host+"/images/img/person.png"),a.value("smilesDir",c.host+"/images/img/smileys"),a.value("soundPath",c.host+"/files/chat_message.wav"),a.value("avatarDir",c.host+"/images/avatars/"),a.value("host_of_server",c.host)}]),angular.module("drahak.chat").run(["Translator","User","Emoticons",function(a,b,e){a.setTranslations(d.translate),e.setEmoji(d.emoticons),b.connect(c.id,c.name,c.stamp,c.token)}]);var e=JSON.parse(localStorage.getItem("chat.config"));if(angular.isUndefined(e)||null===e||e.expires<new Date){var f=new XMLHttpRequest;f.onreadystatechange=function(){if(4===f.readyState&&200===f.status){d=JSON.parse(f.responseText);var a={expires:new Date,config:d};a.expires.setHours(a.expires.getHours()+12),localStorage.setItem("chat.config",JSON.stringify(a)),angular.bootstrap(b,["drahak.chat"])}},f.open("GET","https://"+a.chat.host.slice(5)+":"+c.port+"/config/"+c.lang),f.send(null)}d=e.config,angular.bootstrap(b,["drahak.chat"])}}(),function(){angular.module("drahak.chat").factory("Alert",["$document","LocalStorage","$interval",function(a,b,c){var d=function(a){a.interval=c(function(){a.nextAlert()},1e3,0,!1)},e=function(a){a.alerts.length>0&&null==a.interval?d(a):0==a.alerts.length&&null!=a.interval&&a.reset()},f=function(){this.alerts=[],this.currentIndex=0,this.originalTitle=a[0].title,this.showName=!0,this.interval=null};return f.prototype.setAlert=function(a){for(var b=!1,c=0;c<this.alerts.length&&!b;c++)this.alerts[c].Sender===a.Sender&&(b=!0,0==a.Count?this.alerts.splice(c,1):this.alerts[c]=a);!b&&a.Count>0&&this.alerts.push(a),e(this)},f.prototype.nextAlert=function(){this.showName?(this.currentIndex=this.currentIndex+1>=this.alerts.length?0:this.currentIndex+1,a[0].title=this.alerts[this.currentIndex].Sender+" : "+this.alerts[this.currentIndex].Count):a[0].title=this.originalTitle,this.showName=!this.showName},f.prototype.reset=function(){this.interval&&c.cancel(this.interval),this.alerts=[],this.interval=null,a[0].title=this.originalTitle,this.currentIndex=0},new f}])}(),function(){angular.module("drahak.chat").factory("BatchProcess",["Socket","SocketFilter","FriendsManager","RoomsManager","User","DateUtils",function(a,b,c,d,e,f){var g=function(){a.on("message:batch",function(a){for(var g=0;g<a.length;g++){var h=a[g];h.createdAt=f.parse(h.createdAt);var i=h.sender==e.identity.id?h.recipient:h.sender;c.isFriendWith(i)&&(d.getOrCreate(i,c.get(i).name),b.evoke("message?batch",h))}b.evoke("message?batchProcessed")})};return new g}]),angular.module("drahak.chat").run(["BatchProcess",function(a){}])}(),function(){angular.module("drahak.chat").factory("Connection",["Socket","User",function(a,b){var c=function(c){a.on("connect",function(){c.connected=!0}),a.on("disconnect",function(a,d){c.connected=!1,5!==b.identity.id&&6863!==b.identity.id||console.log("DISCONNECTED",a,d)}),5!==b.identity.id&&6863!==b.identity.id||(localStorage.debug="*")},d=function(a){this.connected=a||!1,c(this)};return d.prototype.isConnected=function(){return this.connected},new d}])}(),function(){!function(){var a={parse:function(a){return angular.isString(a)?new Date(a):a},format:function(a){return a?(a=new Date(a),a.toUTCString()):(new Date).toUTCString()}};angular.module("drahak.chat").value("DateUtils",a)}()}(),function(){angular.module("drahak.chat").factory("Emoticons",["$http","host","port","smilesDir","TextManipulator",function(a,b,c,d,e){var f={":)":"happy.png",":(":"sad.png",":P":"tongue.png",";)":"wink.png",":D":"laughing.png",";(":"crying.png","8-)":"cool.png",":X":"sick.png",":@":"angry.png","8|":"glasses.png",":[":"blushing.png",":`":"whistle.png",":o":"surprised.png",":O":"whoot!.png",o_O:"shocked.png","(v)":"heart.png","]:>":"evil.png"},g=function(d){a.get("https://"+b.slice(5)+":"+c+"/config").then(function(a){d.setEmoji(a.data.emoticons)})},h=function(){this.Emoji={},this.setEmoji(f),g(this)};return h.prototype.getAllEmoticons=function(){return this.Emoji},h.prototype.getEmoticonsURL=function(a){return angular.isUndefined(this.Emoji[a])?a:d+"/"+this.Emoji[a]},h.prototype.setEmoji=function(a){this.Emoji={};for(var b in a)a.hasOwnProperty(b)&&this.addEmoji(b,a[b])},h.prototype.addEmoji=function(a,b){this.Emoji[a]=b,this.Emoji[e.escapeHTML(a)]=b},h.prototype.containsJustEmoticons=function(a){for(var b=0;b<a.length;)if(" "!=a.charAt(b)){var c=!1;for(var d in this.Emoji)if(this.Emoji.hasOwnProperty(d)&&a.substr(b,d.length)==d){b+=d.length,c=!0;break}if(!c)return!1}else b++;return!0},h.prototype.createEmoticons=function(a){var b=this;for(var c in this.Emoji)this.Emoji.hasOwnProperty(c)&&(a=e.replaceByRegex(a,new RegExp(c.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")),function(a){return e.createImage(b.getEmoticonsURL(a))}));return a},new h}])}(),function(){angular.module("drahak.chat").factory("FriendsManager",["Socket","userStates","DEBUG",function(a,b,c){var d=function(a,c){var d=b.sort(a.state,c.state);return 0!==d?d:a.name.toLowerCase()<c.name.toLowerCase()?-1:a.name.toLowerCase()>c.name.toLowerCase()?1:0},e=function(b){a.on("user:friends",function(a){b.friends=a})},f=function(b){a.on("user:state",function(a){b.setState(a.id,a.state)})},g=function(){this.friends=[],e(this),f(this)};return g.prototype.get=function(a){for(var b=0;b<this.friends.length;b++)if(this.friends[b].id==a)return this.friends[b];return null},g.prototype.isOnline=function(a){var c=this.get(a);return null!=c&&c.state==b.states.online},g.prototype.setState=function(a,d){if(b.isState(d)){var e=this.get(a);null!=e&&(e.state=d)}else c&&console.log("State "+d+" is not defined")},g.prototype.isFriendWith=function(a){return null!=this.get(a)},g.prototype.getSortedFriends=function(){return this.friends.slice().sort(d)},g.prototype.getCountOfOnlineUsers=function(){return this.friends.filter(function(a){return a.state==b.states.online}).length},g.prototype.setAllUsersOffline=function(){this.friends.forEach(function(a){a.state=b.states.offline})},new g}]),angular.module("drahak.chat").run(["FriendsManager",function(a){}])}(),function(){angular.module("drahak.chat").value("HashFn",function(a){a=a.toString();var b,c,d,e=0;if(0===a.length)return a;for(b=0,d=a.length;b<d;b++)c=a.charCodeAt(b),e=(e<<5)-e+c,e|=0;return e.toString()})}(),function(){var a=function(){this.id=null,this.name=null,this.token=null,this.timestamp=null};angular.module("drahak.chat").service("Identity",a)}(),function(){var a=function(){function a(a){this.namespace=a,this.storage=localStorage}return a.prototype.set=function(a,b){this.storage.setItem(this.namespace+"."+a,JSON.stringify(b))},a.prototype.clear=function(a){this.storage.removeItem(a)},a.prototype.get=function(a,b){b=b||null;try{var c=JSON.parse(this.storage.getItem(this.namespace+"."+a));return"undefined"==typeof c||null===c?b:c}catch(d){return b}},a}();angular.module("drahak.chat").factory("LocalStorage",function(){var b;return b={},function(c){return"undefined"==typeof b[c]&&(b[c]=new a(c)),b[c]}})}(),function(){angular.module("drahak.chat").factory("MessageFingerprint",["HashFn","DateUtils",function(a,b){return function(c){if(void 0===c||null===c)return null;var d=c.createdAt instanceof Date?b.format(c.createdAt):c.createdAt;return a(c.text)+a(String(c.sender))+a(String(c.recipient))+a(String(d))}}])}(),function(){angular.module("drahak.chat").factory("MessageManagerFactoryFn",["Socket","SocketFilter","MessageFingerprint","DateUtils","FriendsManager","Alert","SoundPlayerFilter","User",function(a,b,c,d,e,f,g,h){function i(a){return new n(a)}var j=function(a){b.on("message:read",function(b){for(var c=0;c<a.messages.length;c++)a.messages[c].sender==b.recipient&&(a.messages[c].unread=!1);f.setAlert({Sender:e.get(a.recipient).name,Count:a.countOfUnreadMessages()})},function(b){return b.sender==a.recipient||b.recipient==a.recipient})},k=function(a){b.on("message?batch",function(b){a.addMessage(b),f.setAlert({Sender:e.get(a.recipient).name,Count:a.countOfUnreadMessages()}),a.loading=!1},function(b){return b.recipient==a.recipient||b.sender==a.recipient})},l=function(a){b.on("message?send",function(b){a.addMessage(b.message,!0)},function(b){return b.recipient==a.recipient})},m=function(a){b.on("message?batchProcessed",function(){a.loading=!1})},n=function(a){this.recipient=a,this.messages=[],this.existingMessages={},this.loading=!0,this.indexOfLastReadMessage=-1,j(this),k(this),l(this),m(this)};return n.prototype.addMessages=function(b,e){e=e||!1,angular.isArray(b)||(b=[b]);for(var f=0;f<b.length;f++){var i;angular.isString(b[f])?i={sender:h.identity.id,recipient:this.recipient,text:b[f],createdAt:d.parse(d.format(new Date)),unread:!0}:angular.isObject(b[f])&&(i=b[f]);var j=c(i);angular.isUndefined(this.existingMessages[j])&&(this.existingMessages[j]=1,this.messages.push(i),e&&a.emit("message:send",{createdAt:d.format(i.createdAt),sender:i.sender,recipient:i.recipient,text:i.text,unread:i.unread}),i.sender==this.recipient&&i.unread&&g.play(this.recipient))}this.messages=this.messages.sort(function(a,b){var c=angular.isString(a.createdAt)?d.parse(a.createdAt):a.createdAt,e=angular.isString(b.createdAt)?d.parse(b.createdAt):b.createdAt;return c-e})},n.prototype.addMessage=function(a,b){this.addMessages([a],b)},n.prototype.countOfUnreadMessages=function(){for(var a=0,b=0;b<this.messages.length;b++)this.messages[b].sender==this.recipient&&this.messages[b].unread&&a++;return a},n.prototype.hasUnreadMessages=function(){return this.countOfUnreadMessages()>0},n.prototype.readAllMessages=function(){a.emit("message:read",{recipient:this.recipient});for(var b=0;b<this.messages.length;b++)this.messages[b].sender==this.recipient&&(this.messages[b].unread=!1)},n.prototype.loadMessagesFromServer=function(b){b=b||new Date,this.loading=!0,a.emit("message:history",{recipient:this.recipient,offset:d.format(b)})},n.prototype.isLoadingMessagesFromServer=function(){return this.loading},n.prototype.getTimeOfFirstLoadedMessage=function(){return this.messages.length>0?new Date(this.messages[0].createdAt):new Date},n.prototype.getLastReadMessage=function(){for(var a=(this.indexOfLastReadMessage,this.indexOfLastReadMessage);a<this.messages.length;a++)this.messages[a]&&this.messages[a].recipient==this.recipient&&!this.messages[a].unread&&(this.indexOfLastReadMessage=a);return this.messages[this.indexOfLastReadMessage]||null},i}])}(),function(){angular.module("drahak.chat").factory("RoomFactory",["MessageManagerFactoryFn","User","userStates","Socket",function(a,b,c,d){function e(a,d){var e=null;if(1===arguments.length&&angular.isObject(arguments[0])){var g=arguments[0];e=new f(g.name,g.recipient),e.expanded=g.expanded}else e=new f(a,d);return c.doNotDisturb(b.identity.state)&&e.expand(!1),e}var f=function(b,c){this.name=b,this.recipient=c,this.expanded=!0,this.messageManager=a(c)};return f.prototype.expand=function(a){return angular.isUndefined(a)?this.expanded:(this.expanded=a,void d.emit("room:expand",{recipient:this.recipient,newState:this.expanded}))},e}])}(),function(){angular.module("drahak.chat").service("RoomsManager",["RoomFactory","LocalStorage","Socket","FriendsManager","Alert",function(a,b,c,d,e){function f(){this.rooms=this.loadStoredRooms(),h(this)}var g=b("manager"),h=function(a){c.on("room:create",function(b){a.getOrCreate(b.recipient,d.get(b.recipient).name,!1)}),c.on("room:close",function(b){a.delete(b.recipient,!1)}),c.on("room:expand",function(b){var c=a.getOrCreate(b.recipient,d.get(b.recipient).name,!1);c.expanded=b.newState,a.store()})};return f.prototype.loadStoredRooms=function(){return{}},f.prototype.store=function(){var a=[];for(var b in this.rooms)if(this.rooms.hasOwnProperty(b)&&null!=this.rooms[b]){var c=this.rooms[b];a.push({expanded:c.expanded,name:c.name,recipient:c.recipient})}g.set("rooms",a)},f.prototype.create=function(b,d,e){angular.isUndefined(e)&&(e=!0);var f=a(b,d);return this.rooms[f.recipient.toString()]=f,this.store(),e&&c.emit("room:create",{recipient:d}),f},f.prototype.getOrCreate=function(a,b,c){var d=this.get(a);return null==d?this.create(b,a,c):d},f.prototype.get=function(a){return a?this.rooms[a.toString()]||null:null},f.prototype.delete=function(a,b){e.setAlert({Sender:d.get(a).name,Count:0}),angular.isUndefined(b)&&(b=!0),b&&c.emit("room:close",{recipient:a}),delete this.rooms[a.toString()],this.store()},new f}])}(),function(){angular.module("drahak.chat").factory("Socket",["host","port","Identity","$rootScope","DEBUG",function(a,b,c,d,e){var f;return f=io.connect("https://chat.itnetwork.cz:"+b, {secure: true}),{emit:function(a,b){b?b.identity=c:b={identity:c};var d=function(){f.connected?(f.emit(a,b),e&&console.log("Send: ",a,b)):setTimeout(d,3e3)};return d(),this},on:function(a,b){return f.on(a,function(){b.apply(this,arguments),d.$apply(),e&&console.log("Receive: ",a,arguments[0])}),this}}}])}(),function(){angular.module("drahak.chat").factory("SocketFilter",["Socket",function(a){var b=function(){this.callbacks={}};return b.prototype.on=function(b,c,d,e){if(angular.isUndefined(this.callbacks[b])){this.callbacks[b]=[];var f=this;a.on(b,function(a){f.evoke(b,a)})}this.callbacks[b].push({Callback:c,Filter:d||function(){return!0},Priority:e||1}),this.callbacks[b]=this.callbacks[b].sort(function(a,b){return a.Priority-b.Priority})},b.prototype.evoke=function(a,b){angular.isUndefined(this.callbacks[a])&&(this.callbacks[a]=[]);for(var c=0;c<this.callbacks[a].length;c++)this.callbacks[a][c].Filter(b)&&this.callbacks[a][c].Callback(b)},b.prototype.remove=function(a){if(angular.isString(a))this.callbacks[a]=[];else if(angular.isFunction(a))for(var b in this.callbacks)this.callbacks.hasOwnProperty(b)&&this.callbacks[b].indexOf(a)>=0&&this.callbacks[b].splice(this.callbacks[b].indexOf(a),1)},new b}])}(),function(){angular.module("drahak.chat").factory("SoundPlayer",["soundPath",function(a){var b=function(){this.sound=new Audio(a),this.sound.volume=.8};return b.prototype.play=function(){this.sound&&this.sound.play()},new b}])}(),function(){angular.module("drahak.chat").factory("SoundPlayerFilter",["SoundPlayer","LocalStorage","User","userStates","$timeout","TabRecognizer",function(a,b,c,d,e,f){var g=function(a){e(function(){a.enabled=!0},1e3,!1)},h=function(){this.activeRecipient=-1,this.enabled=!1,g(this)};return h.prototype.play=function(b){this.activeRecipient!=b&&this.isEnabled()&&a.play()},h.prototype.isEnabled=function(){return this.enabled&&b("settings").get("sounds",!0)&&!d.doNotDisturb(c.identity.state)&&f.isCurrentTabActive()},h.prototype.setActiveRecipient=function(a){this.activeRecipient=a},new h}])}(),function(){angular.module("drahak.chat").factory("TabRecognizer",["LocalStorage",function(a){var b=(new Date).toString(),c=a("tab");c.set("active",b);var d=function(){window.addEventListener("focus",function(){c.set("active",b)})},e=function(){d(this)};return e.prototype.isCurrentTabActive=function(){return c.get("active",b)===b},new e}])}(),function(){!function(){var a=172800,b=function(a){this.storage=a("TempStorage")};b.prototype.get=function(a){var b=this.storage.get(a);if(null==b)return null;var c=new Date;return c-b.expire>0?(this.storage.clear(a),null):b.value},b.prototype.set=function(b,c,d){d=d||a,(!angular.isNumber(d)||d<=0)&&(d=a);var e=new Date;e.setSeconds(e.getSeconds()+d),this.storage.set(b,{value:c,expires:e})},angular.module("drahak.chat").service("TempStorage",["LocalStorage",b])}()}(),function(){angular.module("drahak.chat").factory("TextManipulator",["Translator","host_of_server",function(a,b){var c=/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/i,d={};return d.escapeHTML=function(a){var b=document.createElement("div");return b.appendChild(document.createTextNode(a)),b.innerHTML},d.createCode=function(c,d){for(var e=[],f=0;f<c.length;f++)if(angular.isString(c[f])&&"[code]"===c[f].substr(0,6)&&"[/code]"===c[f].substr(c[f].length-7)){var g=document.createElement("a");g.href=b+"/"+a.getTranslate("article_messages")+"/"+d,g.innerText=a.getTranslate("display_code"),e.push(g)}else e.push(c[f]);return e},d.replaceCodeWithLink=function(a,b){var c,d,e,f,g;for(d=[""],c=f=0,g=a.length;0<=g?f<g:f>g;c=0<=g?++f:--f)"[code]"===a.substr(c,6)&&d.push(""),d[d.length-1]+=a[c],"[/code]"===a.substr(c-6,7)&&(d[d.length-1].length>=50?(d.pop(),d[d.length-1]+=' <a href="http://www.itnetwork.cz/zpravy/'+b+'">zdrojový kód</a> '):(e=d[d.length-1],d[d.length-1]="<code>"+e.substr(6,e.length-13)+"</code>"));return d.join("")},d.replaceUrlWithHtmlLink=function(a){var b=document.createElement("a");return b.target="_blank",b.href=a,b.innerText=a,b},d.createImage=function(a){var b=document.createElement("img");return b.alt="emoticon",b.src=a,b},d.replaceByRegex=function(a,b,c){for(var d=null,e=0;e<a.length;)angular.isString(a[e])?null==(d=b.exec(a[e]))?e++:d[0]==d.input?a.splice(e,1,c(d[0])):(a.splice(e,1),d.index+d[0].length<d.input.length&&a.splice(e,0,d.input.substr(d.index+d[0].length)),a.splice(e,0,d[0]),d.index>0&&a.splice(e,0,d.input.substr(0,d.index))):e++;return a},d.createLinks=function(a){return this.replaceByRegex(a,c,function(a){return d.replaceUrlWithHtmlLink(a)})},d.escapeText=function(a){if(angular.isArray(a))for(var b=0;b<a.length;b++)angular.isString(a[b])&&a.splice(b,1,document.createTextNode(this.escapeHTML(a[b])));return a},d}])}(),function(){angular.module("drahak.chat").factory("Translator",[function(){var a=function(){};return a.prototype.setTranslations=function(a){this.translations=a},a.prototype.translations={search_placeholder:"Search...",tutorial:"The chat show only members with which each subscribed.",reconnect:"Reconnecting..",new_message:"New messages",loading_messages:"Loading messages ...",read:"read",close:"close",online:"online",offline:"offline",busy:"busy",away:"AFK",state_idle:" ",state_typing:"typing...",state_entered:"Sent message",today:"today",yesterday:"yesterday",display_code:"Show source code",article_messages:"messages"},a.prototype.getTranslate=function(a){return this.translations&&!angular.isUndefined(this.translations[a])?this.translations[a]:a},new a}])}(),function(){!function(){angular.module("drahak.chat").factory("User",["Socket","LocalStorage","Identity","$rootScope","userStates","DEBUG","SocketFilter","FriendsManager",function(a,b,c,d,e,f,g,h){var i=function(a){g.on("user:state",function(b){a.identity&&a.setState(b.state,!1)},function(b){return a.identity&&a.identity.id==b.id})},j=function(b){a.on("connect",function(){a.emit("user:init"),b.loading=!0})},k=function(a,b){this.identity=c,this.identity.state=b("chat").get("state")||e.states.online,this.loading=!1,i(this),j(this)};return k.prototype.setState=function(c,d){return angular.isUndefined(d)&&(d=!0),e.isState(c)?(this.identity.state=c,b("chat").set("state",c),d&&a.emit("user:state",{id:this.identity.id,state:c}),void(c===e.states.offline&&h.setAllUsersOffline())):void(f&&console.log("States ",c," is not defined"))},k.prototype.connect=function(a,b,c,d){this.identity.id=a,this.identity.name=b,this.identity.token=d,this.identity.timestamp=c},new k(a,b)}])}()}(),function(){angular.module("drahak.chat").directive("chatActiveRoomWatch",["SoundPlayerFilter",function(a){return{restrict:"A",link:function(b,c,d){var e=-1;b.$watch(d.chatActiveRoomWatch,function(a){e=parseInt(a)}),c.on("focus",function(){a.setActiveRecipient(e)}),c.on("blur",function(){a.activeRecipient==e&&a.setActiveRecipient(-1)})}}}])}(),function(){!function(){angular.module("drahak.chat").directive("chatClickFocus",function(){return{link:function(a,b,c){var d=c.chatClickFocus.split(":"),e=d[0],f=d.length>1?parseInt(d[1]):0;b.on("click",function(){b.find(e)[f].focus()})}}})}()}(),function(){!function(){angular.module("drahak.chat").directive("chatStateInformator",["Socket","writingStates","$timeout",function(a,b,c){function d(b){a.emit("message:state",{state:b,recipient:e})}var e,f={MilisecondToWait:3500,TimeoutPromise:null,CancelTimeout:function(){null!==this.TimeoutPromise&&c.cancel(this.TimeoutPromise),this.TimeoutPromise=null},CreateTimeout:function(a){this.CancelTimeout(),this.TimeoutPromise=c(a,this.MilisecondToWait,!1)},TimeoutSetted:function(){return null!==this.TimeoutPromise}};return{link:function(a,c,g){e=a.recipient;var h=!0;a.$watch(g.ngModel,function(a){""==a&&f.TimeoutSetted()?(f.CancelTimeout(),d(b.idle)):""===a||f.TimeoutSetted()||h||(f.CreateTimeout(function(){d(b.idle),f.CancelTimeout()}),d(b.typing)),h=!1})}}}])}()}(),function(){angular.module("drahak.chat").directive("chatAvatar",["avatarDir","avatarExt","avatarDefault","$http","TempStorage",function(a,b,c,d,e){var f=e.get("avatars")||{};return{restrict:"A",templateUrl:"view/avatar.html",scope:{user:"@"},link:function(d,g,h){d.$watch("user",function(g){if(d.url=f[g]||null,null==d.url){var h=new Image;h.src=a+g+b,h.onload=function(){f[g]=a+g+b,d.url=f[g],d.$apply(),e.set("avatars",f)},h.onerror=function(){f[g]=c,d.url=f[g],d.$apply(),e.set("avatars",f)}}})}}}])}(),function(){angular.module("drahak.chat").directive("chatBootstrap",[function(){return{restrict:"EA",controller:"Chat",templateUrl:"view/chat.html",link:function(a,b,c){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))return void b.remove()}}}])}(),function(){angular.module("drahak.chat").directive("message",["$compile","User","Emoticons","TextManipulator","SocketFilter","$timeout",function(a,b,c,d,e,f){var g=function(a,b){b.innerHTML="";for(var c=0;c<a.length;c++)b.appendChild(a[c])},h=function(a,b){f(function(){e.evoke("room?message",{sender:a,recipient:b})},10)};return{restrict:"E",transclude:!0,templateUrl:"view/message.html",scope:{message:"=src"},link:function(a,e,f){a.user=b.identity;var i=e[0].querySelector(".message-text");return a.$watch("message.text",function(b){var e=a.message.sender===a.user.id?a.message.recipient:a.message.sender;c.containsJustEmoticons(b)&&(a.onlyEmoticons=!0);var f=[b];f=d.createCode(f,e),f=d.createLinks(f),f=c.createEmoticons(f),f=d.escapeText(f),g(f,i),h(a.message.sender,a.message.recipient)})}}}])}(),function(){angular.module("drahak.chat").directive("room",["RoomsManager",function(a){return{restrict:"AE",controller:"Room",scope:{recipient:"@",recipientName:"@"},templateUrl:"view/room.html",link:function(b,c,d){d.$observe("recipient",function(){var c=d.recipient,e=d.recipientName;c&&(b.room=a.getOrCreate(c,e),b.room.messageManager.loadMessagesFromServer())})}}}])}(),function(){angular.module("drahak.chat").directive("focusOn",function(){return{restrict:"A",link:function(a,b,c){a.$watch(c.focusOn,function(a){a&&setTimeout(function(){b[0].focus()})})}}})}(),function(){angular.module("drahak.chat").directive("chatScroll",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e;e=a(d.chatScroll),c.bind("scroll",function(a){var c=this.scrollTop,d=0===c,f=this.scrollHeight-this.clientHeight-c<10;e(b,{$event:a,$isTop:d,$isBottom:f}),b.$apply()})}}}])}(),function(){angular.module("drahak.chat").directive("chatScrollBottomOnMessage",["SocketFilter","$timeout",function(a,b){return{restrict:"A",link:function(c,d,e){function f(){g.scrollTop=g.scrollHeight-g.clientHeight}var g=d[0],h=null;c.$watch(e.chatScrollBottomOnMessage,function(a){a&&(h=a,b(f,150))}),a.on("room?message",function(){f()},function(a){return h&&!c.scrollLocked&&(a.sender==h||a.recipient==h)},2)}}}])}(),function(){angular.module("drahak.chat").filter("timeAgo",function(){return function(a){var b;return b=((new Date).getTime()-new Date(a).getTime())/1e3,b<60?"1m":b<3600?parseInt(b/60)+"m":b<86400?parseInt(b/3600)+"h":""}}),angular.module("drahak.chat").filter("formatDate",["Translator",function(a){function b(a){return a<10?"0"+String(a):String(a)}return function(c){if(angular.isString(c)&&(c=new Date(c)),!(c instanceof Date)||isNaN(c.valueOf()))return c;var d=new Date;d.setHours(0),d.setMinutes(0),d.setSeconds(0);var e=b(c.getHours())+":"+b(c.getMinutes());return d.getTime()-c.getTime()<0?a.getTranslate("today")+" "+e:(d.setDate(d.getDate()-1),d.getTime()-c.getTime()<0?a.getTranslate("yesterday")+" "+e:String(c.getDate())+"."+String(c.getMonth()+1)+". "+e)}}])}(),function(){angular.module("drahak.chat").filter("translate",["Translator",function(a){return function(b){return a.getTranslate(b)}}])}(),function(){angular.module("drahak.chat").filter("truncate",function(){return function(a,b){if("string"!=typeof a||a.length<=b)return a;var c="...";return a.slice(0,b-c.length)+c}})}(),function(){angular.module("drahak.chat").controller("Chat",["$scope","$window","User","RoomsManager","Connection","LocalStorage","states","FriendsManager","userStates",function(a,b,c,d,e,f,g,h,i){a.menuMargin=!0,a.user=c,a.tutorialDisabled=f("chat").get("tutorialDisabled"),a.expanded=f("chat").get("opened"),a.supported=!0,a.chat=d,a.sounds=f("settings").get("sounds",!0),a.$watch("sounds",function(a){return f("settings").set("sounds",a)}),a.getBadge=function(){return e.isConnected()?"badge-"+c.identity.state:"badge-offline"},a.countOfOnlineUsers=function(){return h.getCountOfOnlineUsers()},a.getFriends=function(){return h.getSortedFriends()},angular.element(b).bind("scroll",function(){a.menuMargin=this.pageYOffset<115,a.$apply()}),a.states=g,a.openChat=function(a,b){var c=d.getOrCreate(b,a);c.expand(!0)},a.toggleStateDropdown=function(b){a.expanded&&(b.stopPropagation(),a.stateDropdown=!a.stateDropdown)},a.isConnected=function(){return e.isConnected()},a.selectState=function(b,d){d.stopPropagation(),a.stateDropdown=!1,c.setState(b)},a.$watch("tutorialDisabled",function(a){f("chat").set("tutorialDisabled",Boolean(a))}),a.$watch("expanded",function(b){f("chat").set("opened",b),b||(a.friendsFilter="")})}])}(),function(){angular.module("drahak.chat").controller("Room",["$scope","Socket","RoomsManager","User","SocketFilter","userStates","MessageFingerprint","FriendsManager","writingStates",function(a,b,c,d,e,f,g,h,i){a.user=d,a.state=i.idle,a.close=function(){c.delete(a.recipient)},a.isOnline=function(a){return h.isOnline(a)},a.recipientStatus=function(){return a.room&&h.get(a.room.recipient)?h.get(a.room.recipient).state:f.states.offline},a.dateDiff=function(b,c){return b<0||c<0?Number.MAX_VALUE:Math.abs(new Date(a.room.messageManager.messages[b].createdAt)-new Date(a.room.messageManager.messages[c].createdAt))},a.toggleExpand=function(){a.room.expand(!a.room.expand()),c.store()},a.isLastReadMessage=function(b){return a.room&&!a.room.messageManager.isLoadingMessagesFromServer()&&g(b)===g(a.room.messageManager.getLastReadMessage())},a.scroll=function(b,c){b?a.room.messageManager.loadMessagesFromServer(a.room.messageManager.getTimeOfFirstLoadedMessage()):c?a.scrollLocked=!1:c||b||(a.scrollLocked=!0)},a.send=function(b){b&&b.trim().length&&(a.scrollLocked=!1,e.evoke("message?send",{message:b,recipient:a.room.recipient}),a.room.messageManager.readAllMessages())},a.sendIfEnter=function(b,c){13!==b.keyCode||b.shiftKey||(b.preventDefault(),a.send(c),a.messageText="")},a.read=function(){a.room.messageManager.readAllMessages()},a.isLoadingMessages=function(){return!a.room||a.room.messageManager.isLoadingMessagesFromServer()},a.countOfUnreadMessages=function(){return a.room?a.room.messageManager.countOfUnreadMessages():0},e.on("message:state",function(b){a.state=b.state},function(b){return Number(b.sender)==Number(a.room.recipient)})}])}()}(),function(){angular.module("drahak.chat").run(["$templateCache",function(a){a.put("view/avatar.html",'<div class="avatar">\r\n    <img ng-src="{{ url }}" alt="User avatar"/>\r\n</div>\r\n'),a.put("view/chat.html",'<div class="drahak-chat" data-ng-class="{\'connection-lost\': !isConnected()}">\r\n    <div class="friends" data-ng-class="{\'friends-expanded\': expanded, \'menu-margin\': menuMargin}">\r\n\r\n        <header data-ng-click="expanded = !expanded">\r\n            <div class="badge {{getBadge()}}">\r\n                {{countOfOnlineUsers()}}\r\n            </div>\r\n            <span>{{ user.identity.name }}</span>\r\n        </header>\r\n\r\n        <div class="list-wrapper">\r\n            <div class="list">\r\n                <div class="report report-error" ng-show="!isConnected() && supported">\r\n                    {{ \'reconnect\' | translate}}\r\n                </div>\r\n\r\n                <div class="report report-warning" ng-show="!tutorialDisabled">\r\n                    <a class="close" title="{{ \'close\' | translate}}" ng-click="tutorialDisabled = true">&times;</a>\r\n                    {{ \'tutorial\' | translate}}\r\n                </div>\r\n                <div class="current-state" ng-class="user.identity.state" ng-click="toggleStateDropdown($event)">\r\n                    <div class="state pull-left" ng-class="user.identity.state"></div>\r\n                    <span ng-bind="user.identity.state | translate"></span>\r\n                    <span class="arrow-down pull-right"></span>\r\n                    <ul class="state-dropdown" ng-show="expanded && stateDropdown">\r\n                        <li ng-repeat="state in states track by $index" ng-click="selectState(state, $event)">\r\n                            <div class="state pull-left" ng-class="state"></div>\r\n                            {{ state | translate}}\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n                <ul>\r\n                    <li data-ng-repeat="friend in getFriends() track by $index"\r\n                        data-ng-click="openChat(friend.name, friend.id)"\r\n                        ng-class="friend.state">\r\n\r\n                        <div chat-avatar user="{{ friend.id }}"></div>\r\n                        <div class="name">\r\n                            {{ friend.name }}\r\n                        </div>\r\n                        <div class="state pull-right" ng-class="friend.state"></div>\r\n                        <div class="clearfix"></div>\r\n                    </li>\r\n                </ul>\r\n            </div>\r\n        </div>\r\n\r\n        <div class="tools">\r\n            <input type="text" ng-model="friendsFilter" placeholder="{{ \'search_placeholder\' | translate}}"/>\r\n            <div class="sounds" ng-class="{\'sounds-on\': sounds, \'sounds-off\': !sounds}" ng-click="sounds=!sounds"></div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class="conversation-wrapper">\r\n        <div data-ng-repeat="(recipient,room) in chat.rooms">\r\n            <room recipient="{{ recipient }}" recipientName="{{ room.name }}"></room>\r\n        </div>\r\n        <div class="clearfix"></div>\r\n    </div>\r\n</div>\r\n'),a.put("view/message.html",'<div class="message" ng-class="{\'message-incoming\': message.sender != user.id}">\r\n  <span>\r\n    <div chat-avatar user="{{ message.sender }}" title="{{ message.sender != user.id ? room.name : user.name }}"></div>\r\n  </span>\r\n  <div class="content" ng-class="{\'onlyEmoticons\' : onlyEmoticons}" title="{{ message.createdAt | date:\'dd. MMMM yyyy HH:mm\' }}">\r\n    <span class="date">{{ message.createdAt | formatDate }}</span>\r\n    <p data-ng-transclude class="message-text"></p>\r\n    <div class="clearfix"></div>\r\n  </div>\r\n  <div class="clearfix"></div>\r\n</div>'),a.put("view/room.html",'<div class="conversation"\n     data-chat-click-focus="textarea"\n     data-ng-click="read();"\n     data-ng-class="{\n\t\t\'conversation-minimalized\': !room.expand(),\n\t\t\'conversation-unread\': countOfUnreadMessages() > 0,\n\t\t\'conversation-active\': $index == activeConversation\n\t}">\n\n    <div class="badge badge-unread">{{ countOfUnreadMessages() }}</div>\n    <header ng-click="toggleExpand()">\n        <div class="state pull-left" ng-class="recipientStatus()"></div>\n        <span ng-bind="room.name | truncate:25" ng-show="room.expanded"></span>\n        <span ng-bind="room.name | truncate:10" ng-show="!room.expanded"></span>\n        {{state | translate}}\n        <a class="close" ng-click="close(); $event.stopPropagation()">&times;</a>\n    </header>\n\n    <div class="alert-new"\n         ng-show="countOfUnreadMessages() > 0"\n         ng-click="scrollLocked = false">\n        {{\'new_message\' | translate}} ({{ countOfUnreadMessages() }})\n    </div>\n\n    <div class="messages-wrapper">\n        <section class="messages"\n                 data-chat-scroll="scroll($isTop, $isBottom)"\n                 data-chat-scroll-bottom-on-message="room.recipient">\n\n            <p ng-show="isLoadingMessages()" class="group-date">\n                <span>{{ \'loading_messages\' | translate}}</span>\n            </p>\n\n            <div ng-repeat="message in room.messageManager.messages track by $index"\n                 ng-init="previous = room.messageManager.messages[$index-1] || {}">\n                <p ng-if="dateDiff($index-1, $index) > 4 * 3600 * 1000" class="group-date">\n                    <span class="ng-binding">{{ message.createdAt | formatDate }}</span>\n                </p>\n                <message src="message">{{ message.text }}</message>\n                <div class="message-read" ng-if="isLastReadMessage(message)">{{ \'read\' | translate}} {{ message.createdAt | formatDate }}</div>\n            </div>\n\n        </section>\n    </div>\n\n    <footer class="input">\n\t\t<textarea class="drahak-chat-message-handle"\n                  data-ng-model="messageText"\n                  data-ng-keypress="sendIfEnter($event, messageText)"\n                  data-focus-on="room.expanded"\n                  data-chat-state-informator\n                  data-chat-active-room-watch="{{recipient}}">\n\t\t</textarea>\n    </footer>\n</div>');
}])}();